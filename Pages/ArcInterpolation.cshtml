@page
@model CncGcodeSimulator.Pages.ArcInterpolationModel

<h1>Круговая интерполяция (G2/G3)</h1>

<form method="post">
    <textarea asp-for="UserGCode" rows="15" placeholder="Вставьте сюда G-код с G2/G3..."></textarea><br />
    <button type="submit">▶️ Запустить</button>
</form>

<div style="width:500px; height:500px; border:1px solid #ccc; position:relative;">
    <canvas id="canvas" width="500" height="500" style="position:absolute; left:0; top:0; background-color: white;"></canvas>
</div>

@section Scripts {
    <script>
        const arcData = @Html.Raw(Model.ArcCoordinatesJson);
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const gridSize = 25;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        function drawGrid() {
            ctx.strokeStyle = '#eee';
            ctx.lineWidth = 1;
            for(let x=0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for(let y=0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawAxes() {
            ctx.strokeStyle = 'rgba(255,0,0,0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, canvas.height);
            ctx.stroke();

            ctx.strokeStyle = 'rgba(0,0,255,0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();

            ctx.fillStyle = 'rgba(0,0,255,0.7)';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('X', canvas.width - 20, centerY - 5);

            ctx.fillStyle = 'rgba(255,0,0,0.7)';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('Y', centerX + 5, 20);
        }

        function drawCoordinatesLabels() {
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            for(let x = centerX + gridSize, i = 1; x < canvas.width; x += gridSize, i++) {
                ctx.fillText(i * gridSize, x, centerY + 2);
            }
            for(let x = centerX - gridSize, i = -1; x > 0; x -= gridSize, i--) {
                ctx.fillText(i * gridSize, x, centerY + 2);
            }

            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';

            for(let y = centerY - gridSize, i = 1; y > 0; y -= gridSize, i++) {
                ctx.fillText(i * gridSize, centerX - 5, y);
            }
            for(let y = centerY + gridSize, i = -1; y < canvas.height; y += gridSize, i--) {
                ctx.fillText(i * gridSize, centerX - 5, y);
            }
        }

        function drawZeroPoint() {
            ctx.beginPath();
            ctx.arc(centerX, centerY, 4, 0, 2 * Math.PI);
            ctx.fillStyle = "red";
            ctx.fill();
        }

        function normalizeAngle(angle) {
            while (angle < 0) angle += 2 * Math.PI;
            while (angle >= 2 * Math.PI) angle -= 2 * Math.PI;
            return angle;
        }

        function drawPath(points, arcs) {
            if(points.length === 0 && arcs.length === 0) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawGrid();
            drawAxes();
            drawCoordinatesLabels();
            drawZeroPoint();

            ctx.lineWidth = 2;
            ctx.strokeStyle = 'black';

            // Линейные сегменты
            for(let i=1; i < points.length; i++) {
                ctx.beginPath();
                ctx.moveTo(points[i-1].x, points[i-1].y);
                ctx.lineTo(points[i].x, points[i].y);
                ctx.stroke();
            }

            // Дуги
            arcs.forEach(arc => {
                ctx.beginPath();
                ctx.strokeStyle = 'blue';

                let startAngle = normalizeAngle(arc.startAngle);
                let endAngle = normalizeAngle(arc.endAngle);

                let anticlockwise = !arc.clockwise;

                if(!anticlockwise && endAngle > startAngle) {
                    endAngle -= 2 * Math.PI;
                }
                if(anticlockwise && endAngle < startAngle) {
                    endAngle += 2 * Math.PI;
                }

                ctx.arc(arc.centerX, arc.centerY, arc.radius, startAngle, endAngle, anticlockwise);
                ctx.stroke();
            });
        }

        drawPath(arcData.points, arcData.arcs);
    </script>
}
